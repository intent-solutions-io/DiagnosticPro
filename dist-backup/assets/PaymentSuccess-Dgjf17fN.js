import{r as o,j as e,B as R,R as y}from"./index-Cb9AmbZ7.js";import{C as _,a as v,B as m,b as E,c as P}from"./card-BIPM_yue.js";import{u as M,D as Y,C as D}from"./use-toast-BIVZfLPF.js";const L=()=>{const[g,i]=o.useState("checking"),[p,f]=o.useState(""),[U,N]=o.useState(""),[w,S]=o.useState(""),[I,A]=o.useState(0),[b,h]=o.useState(""),{toast:C}=M(),u=o.useRef(!1);o.useEffect(()=>{const r=new URLSearchParams(window.location.search),l=r.get("session_id"),n=r.get("submission_id");l?u.current||(u.current=!0,k(l)):n?(f(n),u.current||(u.current=!0,j(n))):(i("error"),h("No session ID or submission ID provided"))},[]);const k=async r=>{const l="https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev",n="REDACTED_API_KEY";i("checking");for(let s=0;s<3;s++)try{console.log(`ðŸ” Fetching session (attempt ${s+1}/3):`,r);const t=await fetch(`${l}/checkout/session?id=${encodeURIComponent(r)}`,{method:"GET",headers:{"x-api-key":n}});if(console.log("ðŸ“¡ Response status:",t.status),t.ok){const a=await t.json();console.log("ðŸ“¦ Response data:",a);const x=a.submissionId||a.client_reference_id;if(x){console.log("âœ… Found submissionId:",x),f(x),j(x);return}}if(s<2){console.log(`â³ Retrying in ${2e3/1e3} seconds...`),await new Promise(a=>setTimeout(a,2e3));continue}else throw new Error("Session not ready after retries")}catch(t){if(console.error(`âŒ Attempt ${s+1} failed:`,t),s>=2){i("error"),h("Failed to retrieve checkout session details. Please refresh the page to try again.");return}s<2&&await new Promise(a=>setTimeout(a,2e3))}},j=async r=>{const l="https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev",n="REDACTED_API_KEY";i("polling");for(let d=0;d<30;d++){A(d+1);try{const s=await fetch(`${l}/reports/signed-url?submissionId=${encodeURIComponent(r)}`,{method:"GET",headers:{"x-api-key":n}});if(s.ok){const t=await s.json();if(t.downloadUrl&&t.viewUrl){N(t.downloadUrl),S(t.viewUrl),i("ready"),window.location.href=t.downloadUrl,C({title:"Report Ready!",description:"Your download should start automatically."});return}}}catch(s){console.error(`Attempt ${d+1} failed:`,s)}await new Promise(s=>setTimeout(s,1e3))}i("timeout"),h("Still generating... Please refresh the page in a moment.")},c=(()=>{switch(g){case"ready":return{icon:e.jsx(P,{className:"h-8 w-8 text-green-500"}),title:"Report Ready!",description:"Your diagnostic report is downloading automatically.",badge:e.jsx(m,{className:"bg-green-500/10 text-green-600 border-green-200",children:"Ready"})};case"polling":return{icon:e.jsx(y,{className:"h-8 w-8 text-blue-500 animate-spin"}),title:"Generating Report...",description:`Checking for report... (Attempt ${I}/30)`,badge:e.jsx(m,{className:"bg-blue-500/10 text-blue-600 border-blue-200",children:"Processing"})};case"timeout":return{icon:e.jsx(E,{className:"h-8 w-8 text-yellow-500"}),title:"Still Processing",description:b||"Report generation is taking longer than expected.",badge:e.jsx(m,{className:"bg-yellow-500/10 text-yellow-600 border-yellow-200",children:"Delayed"})};case"error":return{icon:e.jsx(D,{className:"h-8 w-8 text-red-500"}),title:"Error",description:b||"Unable to retrieve report.",badge:e.jsx(m,{className:"bg-red-500/10 text-red-600 border-red-200",children:"Error"})};case"checking":default:return{icon:e.jsx(E,{className:"h-8 w-8 text-muted-foreground"}),title:"Checking Status...",description:"Verifying your payment and report status.",badge:e.jsx(m,{className:"bg-muted text-muted-foreground",children:"Checking"})}}})();return e.jsx("section",{className:"py-12 bg-muted/30",children:e.jsx("div",{className:"container mx-auto px-4",children:e.jsxs("div",{className:"max-w-2xl mx-auto text-center",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:c.icon}),e.jsx("div",{className:"flex items-center justify-center mb-4",children:c.badge}),e.jsx("h1",{className:"text-3xl md:text-4xl font-bold mb-4",children:"Payment Successful!"}),e.jsx("p",{className:"text-lg text-muted-foreground",children:c.description})]}),e.jsx(_,{className:"shadow-lg mb-6",children:e.jsxs(v,{className:"p-6",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:c.icon}),e.jsx("h2",{className:"text-xl font-semibold mb-2",children:c.title}),e.jsx("p",{className:"text-muted-foreground mb-4",children:c.description}),p&&e.jsxs("div",{className:"bg-muted p-4 rounded-lg mb-4",children:[e.jsx("p",{className:"text-sm font-medium",children:"Submission ID:"}),e.jsx("p",{className:"text-sm font-mono",children:p})]}),g==="ready"&&w&&e.jsx("div",{className:"mt-4",children:e.jsxs("a",{href:w,target:"_blank",rel:"noopener noreferrer",className:"inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:[e.jsx(Y,{className:"h-4 w-4 mr-2"}),"View Report in Browser"]})}),g==="timeout"&&e.jsx("div",{className:"mt-4",children:e.jsxs(R,{onClick:()=>window.location.reload(),variant:"outline",size:"lg",children:[e.jsx(y,{className:"h-4 w-4 mr-2"}),"Refresh Page"]})})]})}),e.jsx("div",{className:"flex gap-3 justify-center",children:e.jsx(R,{onClick:()=>window.location.href="/",variant:"outline",size:"lg",children:"Return to Home"})})]})})})};export{L as default};
