# SECTION 7 â€” END-TO-END LIVE TEST PLAN

**Date:** 2025-09-25T18:40:00Z
**Status:** ðŸŸ¡ **READY FOR TESTING** - All infrastructure deployed, requires manual configuration

---

## ðŸŽ¯ LIVE TEST OBJECTIVES

### **Primary Goal**
Execute a complete $4.99 payment flow from DiagnosticPro frontend through to PDF download, verifying every component works in production.

### **Test Flow Overview**
```
1. Frontend (diagnosticpro.io) â†’ Create submission
2. Payment ($4.99) â†’ Stripe Checkout â†’ Payment success
3. Stripe webhook â†’ API Gateway â†’ Cloud Run backend
4. Backend â†’ Vertex AI analysis â†’ PDF generation â†’ Cloud Storage
5. Frontend â†’ Download API â†’ Signed URL â†’ PDF delivery
```

---

## ðŸ”§ REQUIRED MANUAL CONFIGURATIONS

### **1. API Gateway API Key Setup**
```bash
# Create API key for client access
gcloud api-keys create "diagnosticpro-client-key" \
  --display-name="DiagnosticPro Client API Key" \
  --api-target=api="diagpro-gw" \
  --project=diagnostic-pro-prod

# Get the API key value
gcloud api-keys get-key-string "diagnosticpro-client-key" \
  --project=diagnostic-pro-prod
```
**Required for:** Frontend API Gateway access

### **2. Stripe Dashboard Webhook Configuration**
1. Login to [Stripe Dashboard](https://dashboard.stripe.com)
2. Navigate to Developers â†’ Webhooks
3. Add endpoint: `https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/webhook/stripe`
4. Select events: `checkout.session.completed`
5. Copy webhook signing secret
6. Verify matches environment variable: `STRIPE_WEBHOOK_SECRET`

**Required for:** Payment confirmation and analysis triggering

### **3. Frontend Configuration**
Update frontend environment variables:
```javascript
VITE_API_GATEWAY_URL=https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev
VITE_API_KEY=[generated-api-key-from-step-1]
```

---

## ðŸ“‹ LIVE TEST EXECUTION PLAN

### **Phase 1: Infrastructure Verification**
```bash
# 1.1 Test API Gateway endpoints
curl -X POST https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/webhook/stripe
# Expected: 400 (public webhook accessible)

curl -X POST https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/analyzeDiagnostic \
  -H "x-api-key: [GENERATED_KEY]" -H "Content-Type: application/json" -d '{}'
# Expected: 400 (protected endpoint accessible with API key)

# 1.2 Verify backend deployment
gcloud run services describe simple-diagnosticpro \
  --region us-central1 --project diagnostic-pro-prod \
  --format="value(status.conditions[0].status)"
# Expected: True

# 1.3 Check environment variables
gcloud run services describe simple-diagnosticpro \
  --region us-central1 --project diagnostic-pro-prod \
  --format="table(spec.template.spec.containers[0].env[].name)"
# Expected: STRIPE_SECRET_KEY, STRIPE_WEBHOOK_SECRET, REPORT_BUCKET
```

### **Phase 2: Create Test Submission**
```bash
# 2.1 Create submission via API Gateway
curl -X POST https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/saveSubmission \
  -H "x-api-key: [GENERATED_KEY]" \
  -H "Content-Type: application/json" \
  -d '{
    "payload": {
      "equipment_type": "Test Equipment",
      "symptoms": ["Test symptom 1", "Test symptom 2"],
      "model": "TEST-2024",
      "serial": "TEST123456"
    }
  }'
# Expected: {"submissionId": "diag_..."}
# SAVE SUBMISSION_ID for remaining tests
```

### **Phase 3: Payment Processing Test**
```bash
# 3.1 Create Stripe checkout session
curl -X POST https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/createCheckoutSession \
  -H "x-api-key: [GENERATED_KEY]" \
  -H "Content-Type: application/json" \
  -d '{"submissionId": "[SUBMISSION_ID]"}'
# Expected: {"sessionId": "cs_...", "url": "https://checkout.stripe.com/..."}

# 3.2 Complete payment manually
# - Open checkout URL in browser
# - Use Stripe test card: 4242424242424242
# - Complete $4.99 payment
# - Verify success page appears
```

### **Phase 4: Webhook & Analysis Verification**
```bash
# 4.1 Check webhook delivery in Stripe dashboard
# Verify status 200 response to webhook endpoint

# 4.2 Verify submission status update
# Check Firestore submissions/{SUBMISSION_ID}.status changed to "paid"

# 4.3 Monitor analysis processing
curl -X POST https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/analysisStatus \
  -H "x-api-key: [GENERATED_KEY]" \
  -H "Content-Type: application/json" \
  -d '{"submissionId": "[SUBMISSION_ID]"}'
# Expected progression: "paid" â†’ "processing" â†’ "ready"

# 4.4 Check Cloud Run logs
gcloud logging read "resource.type=cloud_run_revision AND resource.labels.service_name=simple-diagnosticpro" \
  --project=diagnostic-pro-prod \
  --limit=20 \
  --filter="textPayload:[SUBMISSION_ID]"
# Expected: Analysis started, Vertex AI call, PDF generated
```

### **Phase 5: PDF Generation Verification**
```bash
# 5.1 Verify PDF file exists in Cloud Storage
gsutil ls gs://diagnostic-pro-prod_diagnostic-reports/reports/[SUBMISSION_ID].pdf
# Expected: File exists

# 5.2 Check Firestore analysis record
# Verify analysis/{SUBMISSION_ID} exists with path and status="ready"

# 5.3 Download PDF directly (for verification)
gsutil cp gs://diagnostic-pro-prod_diagnostic-reports/reports/[SUBMISSION_ID].pdf /tmp/test-report.pdf
file /tmp/test-report.pdf
# Expected: ASCII text (text-based PDF)
```

### **Phase 6: Download API Test**
```bash
# 6.1 Generate signed download URL
curl -X POST https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/getDownloadUrl \
  -H "x-api-key: [GENERATED_KEY]" \
  -H "Content-Type: application/json" \
  -d '{"submissionId": "[SUBMISSION_ID]"}'
# Expected: {"url": "https://storage.googleapis.com/...", "expiresInSeconds": 900}

# 6.2 Test signed URL download
curl -o /tmp/downloaded-report.pdf "[SIGNED_URL]"
# Expected: PDF file downloaded successfully

# 6.3 Verify PDF content
head -20 /tmp/downloaded-report.pdf
# Expected: DiagnosticPro report with submission data and AI analysis
```

---

## âœ… SUCCESS CRITERIA

### **Infrastructure Tests**
- [x] API Gateway accessible with public webhook endpoint
- [x] Protected endpoints require valid API key
- [x] Backend deployment healthy and current
- [x] Environment variables configured correctly

### **Payment Processing**
- [ ] Submission created successfully with unique ID
- [ ] Stripe checkout session generated ($4.99)
- [ ] Payment completed with test card
- [ ] Webhook received by backend with 200 response
- [ ] Submission status updated to "paid" in Firestore

### **AI Analysis Pipeline**
- [ ] Analysis processing triggered automatically after payment
- [ ] Vertex AI called with diagnostic payload
- [ ] AI analysis completed with structured response
- [ ] PDF report generated with analysis results
- [ ] PDF uploaded to Cloud Storage bucket
- [ ] Analysis record created in Firestore
- [ ] Submission status updated to "ready"

### **Download Functionality**
- [ ] Download URL generated with 15-minute expiration
- [ ] Signed URL provides direct access to PDF
- [ ] PDF content includes diagnostic analysis and recommendations
- [ ] URL expires after 900 seconds as expected

---

## ðŸš¨ EXPECTED TEST RESULTS

### **Timing Expectations**
- **Submission creation:** <1 second
- **Checkout session:** <2 seconds
- **Payment processing:** 10-30 seconds (user interaction)
- **Webhook delivery:** <5 seconds
- **Vertex AI analysis:** 10-30 seconds
- **PDF generation:** <5 seconds
- **Total end-to-end:** 2-5 minutes

### **Firestore Data Verification**
```javascript
// submissions/{submissionId}
{
  status: "ready",
  payload: { /* original diagnostic data */ },
  createdAt: "2025-09-25T18:40:00Z",
  paidAt: "2025-09-25T18:41:00Z",
  completedAt: "2025-09-25T18:43:00Z",
  stripeSessionId: "cs_...",
  amountPaid: 4.99
}

// analysis/{submissionId}
{
  path: "reports/{submissionId}.pdf",
  status: "ready",
  processedAt: "2025-09-25T18:43:00Z",
  model: "gemini-2.0-flash-exp",
  confidence: 0.85
}
```

### **Generated PDF Content**
```
DIAGNOSTICPRO UNIVERSAL EQUIPMENT DIAGNOSTIC REPORT
==================================================

Submission ID: diag_1727294400000_a1b2c3d4
Date: 9/25/2025
Price: $4.99 USD

EQUIPMENT INFORMATION
--------------------
{
  "equipment_type": "Test Equipment",
  "symptoms": ["Test symptom 1", "Test symptom 2"],
  "model": "TEST-2024",
  "serial": "TEST123456"
}

DIAGNOSTIC ANALYSIS
------------------
{
  "summary": "Professional analysis of test equipment diagnostic data...",
  "root_causes": ["Primary identified issue", "Secondary factor"],
  "confidence": 0.85,
  "recommendations": ["Step 1", "Step 2", "Step 3"],
  "cost_ranges": [{"repair": "Main repair", "min": 100, "max": 300}]
}

---
Generated by DiagnosticPro AI System
Report ID: diag_1727294400000_a1b2c3d4
```

---

## ðŸ” TROUBLESHOOTING GUIDE

### **Common Issues & Solutions**

| Issue | Symptoms | Solution |
|-------|----------|----------|
| **API Key Invalid** | 401/403 from API Gateway | Verify API key generated and configured correctly |
| **Webhook Not Received** | Payment succeeds but no analysis | Check Stripe webhook URL and signing secret |
| **Analysis Stuck Processing** | Status never changes to "ready" | Check Cloud Run logs for Vertex AI errors |
| **PDF Not Generated** | Analysis ready but no file | Check Cloud Storage permissions and bucket name |
| **Download URL Fails** | 404/500 from getDownloadUrl | Verify Firestore analysis record exists |

### **Monitoring Commands**
```bash
# Real-time backend logs
gcloud logging tail "resource.type=cloud_run_revision" --project=diagnostic-pro-prod

# Check Firestore documents
gcloud firestore databases documents list --collection-group=submissions --project=diagnostic-pro-prod

# Verify Cloud Storage files
gsutil ls -la gs://diagnostic-pro-prod_diagnostic-reports/reports/

# Test API Gateway health
curl -s https://diagpro-gw-3tbssksx-3tbssksx.uc.gateway.dev/webhook/stripe -w "%{http_code}"
```

---

**STATUS:** ðŸŸ¡ **INFRASTRUCTURE READY** - All components deployed, requires API key generation and live testing
**NEXT:** Section 8 - Final bucket cleanup after successful end-to-end validation